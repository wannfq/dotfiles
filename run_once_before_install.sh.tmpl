#!/bin/bash
#
# Chezmoi run_once_before script for installing packages and tools
# This script runs once on first `chezmoi apply` and is idempotent
#

set -e

# =============================================================================
# Colors for output
# =============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# =============================================================================
# Helper functions
# =============================================================================

command_exists() {
    command -v "$1" &> /dev/null
}

# =============================================================================
# OS Detection
# =============================================================================

{{ if eq .chezmoi.os "darwin" -}}
OS="macos"
{{- else if eq .chezmoi.os "linux" -}}
{{-   if eq .chezmoi.osRelease.id "arch" }}
OS="arch"
{{-   else }}
OS="linux-other"
{{-   end }}
{{- else -}}
OS="unknown"
{{- end }}

info "Detected OS: $OS"

if [ "$OS" = "unknown" ] || [ "$OS" = "linux-other" ]; then
    error "Unsupported OS. This script supports macOS and Arch Linux only."
    exit 1
fi

# =============================================================================
# Package Manager Setup
# =============================================================================

{{ if eq .chezmoi.os "darwin" -}}
# macOS: Install Homebrew if not present
if ! command_exists brew; then
    info "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add brew to PATH for this session
    eval "$(/opt/homebrew/bin/brew shellenv)"
    success "Homebrew installed"
else
    info "Homebrew already installed"
fi
{{- else if eq .chezmoi.os "linux" }}
{{-   if eq .chezmoi.osRelease.id "arch" }}
# Arch Linux: Install yay if not present
if ! command_exists yay; then
    if ! command_exists pacman; then
        error "pacman not found. Are you sure this is Arch Linux?"
        exit 1
    fi
    
    info "Installing yay (AUR helper)..."
    sudo pacman -S --needed --noconfirm git base-devel
    
    TEMP_DIR=$(mktemp -d)
    git clone https://aur.archlinux.org/yay.git "$TEMP_DIR/yay"
    cd "$TEMP_DIR/yay"
    makepkg -si --noconfirm
    cd -
    rm -rf "$TEMP_DIR"
    success "yay installed"
else
    info "yay already installed"
fi
{{-   end }}
{{- end }}

# =============================================================================
# Unified install function
# Usage: install <command> <pkg_macos> <pkg_arch> [type]
# - command: The command to check if already installed
# - pkg_macos: Package name for Homebrew (macOS)
# - pkg_arch: Package name for yay/pacman (Arch Linux)
# - type: "pkg" (default) or "cask" (macOS only, ignored on Arch)
# =============================================================================

install() {
    local cmd="$1"
    local pkg_macos="$2"
    local pkg_arch="$3"
    local type="${4:-pkg}"

    # Check if command already exists
    if [ -n "$cmd" ] && command_exists "$cmd"; then
        info "$cmd already installed"
        return 0
    fi

    {{ if eq .chezmoi.os "darwin" -}}
    local pkg="$pkg_macos"
    
    if [ "$type" = "cask" ]; then
        if brew list --cask "$pkg" &> /dev/null; then
            info "$pkg already installed"
        else
            info "Installing $pkg (cask)..."
            brew install --cask "$pkg"
            success "$pkg installed"
        fi
    else
        if brew list "$pkg" &> /dev/null; then
            info "$pkg already installed"
        else
            info "Installing $pkg..."
            brew install "$pkg"
            success "$pkg installed"
        fi
    fi
    {{- else if eq .chezmoi.os "linux" }}
    {{-   if eq .chezmoi.osRelease.id "arch" }}
    local pkg="$pkg_arch"
    
    if yay -Q "$pkg" &> /dev/null; then
        info "$pkg already installed"
    else
        info "Installing $pkg..."
        yay -S --noconfirm "$pkg"
        success "$pkg installed"
    fi
    {{-   end }}
    {{- end }}
}

# =============================================================================
# Core Utils (install if missing)
# =============================================================================

info "Checking core utilities..."

install git git git
install curl curl curl
{{ if eq .chezmoi.os "linux" -}}
{{-   if eq .chezmoi.osRelease.id "arch" }}
install man man-db man-db
{{-   end }}
{{- end }}

# =============================================================================
# CLI Tools
# =============================================================================

info "Installing CLI tools..."

#        command     macOS pkg       Arch pkg
install  nvim        neovim          neovim
install  tmux        tmux            tmux
install  zsh         zsh             zsh
install  yazi        yazi            yazi
install  fastfetch   fastfetch       fastfetch
install  eza         eza             eza
install  bat         bat             bat
install  fzf         fzf             fzf
install  zoxide      zoxide          zoxide
install  lazygit     lazygit         lazygit
install  lazydocker  lazydocker      lazydocker
install  rg          ripgrep         ripgrep
install  jq          jq              jq
install  yq          yq              yq
install  fd          fd              fd
install  fx          fx              fx
install  curlie      curlie          curlie
install  delta       git-delta       git-delta
install  btop        btop            btop
install  tldr        tealdeer        tealdeer

# =============================================================================
# Terminal Emulators
# =============================================================================

info "Installing terminal emulators..."

#        command     macOS pkg       Arch pkg        type
install  ghostty     ghostty         ghostty         cask
install  kitty       kitty           kitty           cask

# =============================================================================
# Dev Tools
# =============================================================================

info "Installing dev tools..."

#        command       macOS pkg     Arch pkg
install  k9s           k9s           k9s
install  kubectl       kubectl       kubectl
install  kubectl-krew  krew          krew
install  docker        docker        docker          cask
install  gh            gh            github-cli

# =============================================================================
# Fonts (Nerd Fonts)
# Fonts don't have commands to check, so we pass empty string
# =============================================================================

info "Installing Nerd Fonts..."

{{ if eq .chezmoi.os "darwin" -}}
# Tap homebrew fonts
brew tap homebrew/cask-fonts 2>/dev/null || true
{{- end }}

#        command  macOS pkg                       Arch pkg                type
install  ""       font-meslo-lg-nerd-font         ttf-meslo-nerd          cask
install  ""       font-monaspice-nerd-font        otf-monaspace-nerd      cask
install  ""       font-jetbrains-mono-nerd-font   ttf-jetbrains-mono-nerd cask

# =============================================================================
# mise (Runtime Version Manager)
# =============================================================================

if ! command_exists mise; then
    info "Installing mise..."
    curl https://mise.run | sh
    success "mise installed"
else
    info "mise already installed"
fi

# =============================================================================
# OpenCode (AI Coding Agent)
# =============================================================================

if ! command_exists opencode; then
    info "Installing OpenCode..."
    curl -fsSL https://opencode.ai/install | bash
    success "OpenCode installed"
else
    info "OpenCode already installed"
fi

# =============================================================================
# zimfw (Zsh Plugin Manager)
# =============================================================================

if [ ! -d "$HOME/.zim" ] && [ ! -d "${XDG_CONFIG_HOME:-$HOME/.config}/zsh/.zim" ]; then
    info "Installing zimfw..."
    curl -fsSL https://raw.githubusercontent.com/zimfw/install/master/install.zsh | zsh
    success "zimfw installed"
else
    info "zimfw already installed"
fi

# =============================================================================
# TPM (Tmux Plugin Manager)
# =============================================================================

TPM_DIR="$HOME/.tmux/plugins/tpm"
TPM_DIR_XDG="${XDG_CONFIG_HOME:-$HOME/.config}/tmux/plugins/tpm"

if [ ! -d "$TPM_DIR" ] && [ ! -d "$TPM_DIR_XDG" ]; then
    info "Installing TPM (Tmux Plugin Manager)..."
    git clone https://github.com/tmux-plugins/tpm "$TPM_DIR"
    success "TPM installed"
else
    info "TPM already installed"
fi

# Install tmux plugins
if [ -f "$TPM_DIR/bin/install_plugins" ]; then
    info "Installing tmux plugins..."
    "$TPM_DIR/bin/install_plugins"
    success "Tmux plugins installed"
elif [ -f "$TPM_DIR_XDG/bin/install_plugins" ]; then
    info "Installing tmux plugins..."
    "$TPM_DIR_XDG/bin/install_plugins"
    success "Tmux plugins installed"
fi

# =============================================================================
# Yazi Plugins
# =============================================================================

if command_exists ya; then
    info "Installing yazi plugins..."
    ya pkg install
    success "Yazi plugins installed"
else
    warn "ya command not found, skipping yazi plugin installation"
fi

# =============================================================================
# Done
# =============================================================================

echo ""
success "=============================================="
success "Installation complete!"
success "=============================================="
echo ""
info "Notes:"
info "  - Neovim plugins will auto-install on first launch"
info "  - Zim modules will auto-install on first zsh startup"
info "  - You may need to restart your shell for changes to take effect"
echo ""
